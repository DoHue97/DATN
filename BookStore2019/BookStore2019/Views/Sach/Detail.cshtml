@using BookStore2019.Services
@using ValuesObject
@model OSanPham
@{
    ViewBag.Title = "Chi tiết sản phẩm " + Model.TenSanPham;

    var listTacGia = ViewBag.ListTacGia as List<OTacGia>;
    var listImage = ViewBag.ListImages as List<OImageSach>;
    var listOthers = ViewBag.ListOrther as List<OSanPham>;
}

<div class="content-top">
    @Html.Partial("Categories")
    <div class="col-sm-9">
        <div class="img-product">
            <ul class="slider_pro">
                @if (listImage.Count > 0 && listImage != null)
                {
                    <li>
                        <a href="#">
                            <img src="@Url.Content(Model.Anh)" alt="Alternate Text" class="" height="300" />
                        </a>
                    </li>
                    foreach (var item in listImage)
                    {
                        <li>
                            <a href="#">
                                <img src="@Url.Content(item.DuongDan)" alt="Alternate Text" class="" height="300" />
                            </a>
                        </li>
                    }
                }
                else
                {
                    <li>
                        <a href="#">
                            <img src="@Url.Content(Model.Anh)" alt="Alternate Text" class="" height="300" />
                        </a>
                    </li>
                }

            </ul>

        </div>
        <div class="info-detail">
            <h2>@Model.TenSanPham</h2>
            @if (Model.IsSach == true)
            {
                <span>
                    Tác giả:
                    @if (listTacGia.Count > 0 && listTacGia != null)
                    {
                        foreach (var item in listTacGia)
                        {
                            <strong><a href="#"> @item.Ten , </a></strong>
                        }
                    }
                    else
                    {
                        <strong><a href="#"> Đang cập nhật </a></strong>
                    }
                </span>
                <br />
                <span>Nhà xuất bản: <strong>@Model.TenNXB</strong></span><br />
                <span>Năm xuất bản: @Model.NamXB</span><br />
                <span>Số trang: @Model.SoTrang</span><br />
                if (Model.DichGia != null || Model.DichGia != "")
                {
                    <p>Dịch giả: @Model.DichGia</p>
                }
            }
            @if (Model.SoLuong <= 0)
            {
                <p style="color:red;font-weight:bold;">Hết hàng</p>
            }
            @if (Model.TenNCC != null && Model.TenNCC != "")
            {
                <p>Nhà cung cấp: @Model.TenNCC</p>
            }
            else
            {
                <p>Nhà cung cấp: <strong>Đang cập nhật</strong></p>
            }

            @if (Model.Sale > 0)
            {
                <h4 class="price-old"> Giá bán: @String.Format("{0:#,##0.##}", Model.GiaBan)  VND</h4>
                <h4 class="price-sale">
                    <strong>

                        Giá khuyến mại:  @String.Format("{0:#,##0.##}", Model.GiaBan - Model.GiaBan * Model.Sale / 100) VND
                    </strong>
                </h4>

            }

            else
            {
                <h4 class="">Giá bán: @String.Format("{0:#,##0.##}", Model.GiaBan) VND</h4>
            }

                <div class="form-inline quality">
                    <input type="hidden" name="idpro" value="@Model.MaSanPham" />
                    <input type="number" name="quality" value="1" min="1" max="100" pattern="^-?([0-9]*\.?[0-9]+|[0-9]+\.?[0-9]*)$" class=" form-control" />
                    <br />

                    <button type="button" class="btn btn-danger" id="addToCart" onclick="updateCart()">
                        <i class="fas fa-cart-plus"></i>
                        Chọn mua
                    </button>
                    <span class="error" id="mssg_@Model.MaSanPham"></span>
                </div>
            <hr />

        </div>
        <div class="clearfix"></div>
        <div class="description-pro">
            <h3>Giới thiệu</h3>
            @MvcHtmlString.Create(Model.MoTa) <br />
        </div>
        <hr />
        <div class="orther_policy">
            <h3>Dịch vụ và khuyến mại liên quan</h3>
            <ul>
                <li>
                    - Hoàn tiền cho khách khi sản phẩm bị lỗi
                </li>
                <li>
                    - Thanh toán khi giao hàng
                </li>
            </ul>
        </div>
        <div class="clearfix"></div>

    </div>
    <div class="clearfix"></div>
    <div class="col-md-12 divOrther">
        <div class="orther_pro">
            <h3>Sản phẩm cùng loại</h3>
            @if (listOthers.Count > 0 && listOthers != null)
            {
                <ul class="slider_orthers clearfix">

                    @foreach (var item in listOthers.Take(6))
                    {
                        <li class="col-2 item_other">
                            <a href="@Url.Action("Detail", "Sach", new { shortname = item.TenVanTat })">
                                <img src="@Url.Content(item.Anh)" alt="Alternate Text" height="200" />
                            </a>
                        </li>
                    }
                </ul>
            }

        </div>
    </div>
</div>
<div class="clearfix"></div>
<script>
    setAdminCurrentUrl('@Url.Action("Detail", "Sach")', '@Url.Action("GetAll", "Sach")');
</script>
<script>
    $(document).ready(function () {
        $('.slider_pro').bxSlider({
            auto: true,
            adaptiveHeight: true,
            speed: 1000,
            pause: 7000,
            pager: false,
        });
        //$('.slider_orthers').bxSlider({
        //    auto: true,
        //    adaptiveHeight: true,
        //    speed: 1000,
        //    pause: 7000,
        //    pager: false,
        //    maxSlides: 6,
        //    moveSlides: 6,
        //    slideWidth: 200,
        //    slideMargin: 5,
        //    infiniteLoop: false
        //});
    });
</script>
<script>
    function updateCart() {
        debugger;
        var quanlity = $("input[name='quality']").val();
        
        
        var idpro = $("input[name='idpro']").val();
        var msg = "#mssg_" + idpro;
        if (quanlity <= 0) {

            $(msg).text("Mời bạn nhập lại số lượng!");
            return false;
        }
        $(msg).text("");
            $.ajax({
                url: '@Url.Action("AddToCart", "ProductAction")',
                data: {
                    proid: idpro,
                    quanlity: quanlity
                },
                type: 'post',
                dataType: 'json',
                success: function (data) {
                    debugger;
                    if (data.Success) {
                        var totalItems = 0;
                        for (var i = 0; i < data.Cart.ListItem.length; i++) {
                            var Item = data.Cart.ListItem[i];
                            totalItems += Item.Quantity;
                        }
                        $("#totalItem").text(totalItems);
                        $("#totalItem").load(window.location.href + " #totalItem");
                    } else {
                        if (data.Flag === "0") {
                            alert(data.Message);
                        } else {
                            alert(data.Message);
                        }
                    }
                }
            });
        }
    //$(document).ready(function () {
    //    debugger;

    //}

</script>